# SingBox Limiter - é¡¹ç›®å®Œæˆæ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½

### Phase 1: åç«¯æ ¸å¿ƒ API âœ“

1. **Express æœåŠ¡å™¨** ([server/index.js](server/index.js))
   - CORS æ”¯æŒ
   - é”™è¯¯å¤„ç†ä¸­é—´ä»¶
   - æ—¥å¿—ä¸­é—´ä»¶
   - é™æ€æ–‡ä»¶æœåŠ¡

2. **SQLite æ•°æ®åº“** ([server/utils/database.js](server/utils/database.js))
   - `clients` è¡¨ï¼šå®¢æˆ·ç«¯ä¿¡æ¯
   - `traffic_history` è¡¨ï¼šæµé‡å†å²è®°å½•
   - `settings` è¡¨ï¼šç³»ç»Ÿè®¾ç½®
   - `audit_logs` è¡¨ï¼šå®¡è®¡æ—¥å¿—
   - å®Œæ•´çš„ CRUD æ“ä½œå‡½æ•°

3. **è®¤è¯ç³»ç»Ÿ** ([server/middleware/auth.js](server/middleware/auth.js))
   - JWT Token è®¤è¯
   - bcrypt å¯†ç åŠ å¯†
   - ç®¡ç†å‘˜ç™»å½•éªŒè¯
   - è·¯ç”±æƒé™æ§åˆ¶

4. **å®¢æˆ·ç«¯ç®¡ç† API** ([server/routes/clients.js](server/routes/clients.js))
   - âœ“ GET /api/clients - è·å–æ‰€æœ‰å®¢æˆ·ç«¯
   - âœ“ POST /api/clients - åˆ›å»ºå®¢æˆ·ç«¯
   - âœ“ GET /api/clients/:id - è·å–è¯¦æƒ…
   - âœ“ PUT /api/clients/:id - æ›´æ–°é…ç½®
   - âœ“ DELETE /api/clients/:id - åˆ é™¤å®¢æˆ·ç«¯
   - âœ“ GET /api/clients/:id/traffic - æµé‡å†å²
   - âœ“ POST /api/clients/:id/reset-traffic - é‡ç½®æµé‡
   - âœ“ GET /api/clients/:id/urls - è·å–è¿æ¥ URL
   - âœ“ GET /api/clients/:id/docker-compose - ç”Ÿæˆ docker-compose

5. **SingBox é…ç½®ç”Ÿæˆ** ([server/utils/singbox-config.js](server/utils/singbox-config.js))
   - Reality æœåŠ¡å™¨é…ç½®ç”Ÿæˆ
   - Hysteria2 æœåŠ¡å™¨é…ç½®ç”Ÿæˆ
   - Reality URL æ„å»º
   - Hysteria2 URL æ„å»º
   - Docker Compose é…ç½®ç”Ÿæˆ

6. **è¯ä¹¦ç”Ÿæˆå·¥å…·** ([server/utils/cert-generator.js](server/utils/cert-generator.js))
   - è‡ªç­¾å SSL è¯ä¹¦ç”Ÿæˆ
   - Reality å¯†é’¥å¯¹ç”Ÿæˆï¼ˆx25519ï¼‰
   - ShortID ç”Ÿæˆ

### Phase 2: æµé‡ç›‘æ§é›†æˆ âœ“

7. **Docker æµé‡ç›‘æ§** ([server/services/docker-monitor.js](server/services/docker-monitor.js))
   - âœ“ é€šè¿‡ Docker API è¯»å–å®¹å™¨ç½‘ç»œç»Ÿè®¡
   - âœ“ è®¡ç®—æµé‡å¢é‡ï¼ˆä¸Šä¼ /ä¸‹è½½ï¼‰
   - âœ“ å®æ—¶ç›‘æ§æ‰€æœ‰å®¢æˆ·ç«¯å®¹å™¨
   - âœ“ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»º/å¯åŠ¨/åœæ­¢/åˆ é™¤ï¼‰
   - âœ“ å®¹å™¨çŠ¶æ€æ£€æŸ¥

8. **æµé‡é™åˆ¶é€»è¾‘** ([server/services/limiter.js](server/services/limiter.js))
   - âœ“ è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸå®¢æˆ·ç«¯
   - âœ“ è‡ªåŠ¨æ£€æŸ¥æµé‡è¶…é™å®¢æˆ·ç«¯
   - âœ“ è‡ªåŠ¨åœç”¨è¶…é™/è¿‡æœŸå®¢æˆ·ç«¯
   - âœ“ æœˆåº¦æµé‡è‡ªåŠ¨é‡ç½®
   - âœ“ å®¡è®¡æ—¥å¿—è®°å½•

9. **å®šæ—¶ä»»åŠ¡**
   - âœ“ æµé‡ç›‘æ§ï¼ˆæ¯ N ç§’ï¼Œå¯é…ç½®ï¼‰
   - âœ“ é™åˆ¶æ£€æŸ¥ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰

10. **åˆ†äº«é¡µé¢ API** ([server/routes/share.js](server/routes/share.js))
    - âœ“ å…¬å¼€è®¿é—®ï¼ˆæ— éœ€è®¤è¯ï¼‰
    - âœ“ æ˜¾ç¤ºæµé‡ä½¿ç”¨æƒ…å†µ
    - âœ“ æ˜¾ç¤ºåˆ°æœŸæ—¶é—´
    - âœ“ æ˜¾ç¤ºä¸‹æ¬¡é‡ç½®æ—¶é—´
    - âœ“ 24 å°æ—¶æµé‡è¶‹åŠ¿
    - âœ“ è¿æ¥ URL ç”Ÿæˆ

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
singbox-limiter/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ index.js                    # ä¸»æœåŠ¡å™¨ âœ“
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.js                 # è®¤è¯ API âœ“
â”‚   â”‚   â”œâ”€â”€ clients.js              # å®¢æˆ·ç«¯ API âœ“
â”‚   â”‚   â””â”€â”€ share.js                # åˆ†äº«é¡µé¢ API âœ“
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js                 # JWT è®¤è¯ä¸­é—´ä»¶ âœ“
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ docker-monitor.js       # Docker æµé‡ç›‘æ§ âœ“
â”‚   â”‚   â””â”€â”€ limiter.js              # æµé‡é™åˆ¶é€»è¾‘ âœ“
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ database.js             # SQLite æ•°æ®åº“ âœ“
â”‚       â”œâ”€â”€ cert-generator.js       # è¯ä¹¦ç”Ÿæˆ âœ“
â”‚       â””â”€â”€ singbox-config.js       # é…ç½®ç”Ÿæˆ âœ“
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html                  # API æ–‡æ¡£é¡µé¢ âœ“
â”œâ”€â”€ data/                           # æ•°æ®åº“ç›®å½• âœ“
â”œâ”€â”€ certs/                          # è¯ä¹¦ç›®å½• âœ“
â”œâ”€â”€ configs/clients/                # å®¢æˆ·ç«¯é…ç½® âœ“
â”œâ”€â”€ package.json                    # ä¾èµ–é…ç½® âœ“
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡æ¨¡æ¿ âœ“
â”œâ”€â”€ .gitignore                      # Git å¿½ç•¥è§„åˆ™ âœ“
â”œâ”€â”€ Dockerfile                      # Docker é•œåƒ âœ“
â”œâ”€â”€ docker-compose.yml              # Docker ç¼–æ’ âœ“
â”œâ”€â”€ README.md                       # é¡¹ç›®è¯´æ˜ âœ“
â”œâ”€â”€ DEVELOPMENT.md                  # å¼€å‘æŒ‡å— âœ“
â”œâ”€â”€ DEPLOYMENT.md                   # éƒ¨ç½²æŒ‡å— âœ“
â”œâ”€â”€ start.sh                        # å¿«é€Ÿå¯åŠ¨è„šæœ¬ âœ“
â””â”€â”€ test-api.sh                     # API æµ‹è¯•è„šæœ¬ âœ“
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ¬åœ°å¼€å‘

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env ä¿®æ”¹é…ç½®

# 3. ç”Ÿæˆè¯ä¹¦
npm run init-cert

# 4. å¯åŠ¨æœåŠ¡
npm run dev  # å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
npm start    # ç”Ÿäº§æ¨¡å¼
```

### Docker éƒ¨ç½²

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### è®¿é—®æœåŠ¡

- API æ–‡æ¡£: `http://localhost:3000`
- å¥åº·æ£€æŸ¥: `http://localhost:3000/health`
- é»˜è®¤è´¦å·: `admin` / `admin`ï¼ˆåŠ¡å¿…ä¿®æ”¹ï¼‰

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½æµç¨‹

### 1. åˆ›å»ºå®¢æˆ·ç«¯

```
ç”¨æˆ·è¯·æ±‚åˆ›å»ºå®¢æˆ·ç«¯
    â†“
ç”Ÿæˆ UUIDã€å¯†é’¥ã€é…ç½®
    â†“
å†™å…¥æ•°æ®åº“
    â†“
ç”Ÿæˆ sing-box é…ç½®æ–‡ä»¶
    â†“
åˆ›å»º Docker å®¹å™¨
    â†“
å¯åŠ¨å®¹å™¨
    â†“
è¿”å›å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆå«è¿æ¥ URLï¼‰
```

### 2. æµé‡ç›‘æ§

```
å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 60 ç§’ï¼‰
    â†“
éå†æ‰€æœ‰æ´»è·ƒå®¢æˆ·ç«¯
    â†“
é€šè¿‡ Docker API è¯»å–å®¹å™¨ç½‘ç»œç»Ÿè®¡
    â†“
è®¡ç®—æµé‡å¢é‡ï¼ˆcurrent - lastï¼‰
    â†“
å†™å…¥ traffic_history è¡¨
    â†“
ç´¯åŠ åˆ°å®¢æˆ·ç«¯ used_bytes
```

### 3. æµé‡é™åˆ¶

```
å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
    â†“
æ£€æŸ¥è¿‡æœŸå®¢æˆ·ç«¯ â†’ åœç”¨å®¹å™¨
    â†“
æ£€æŸ¥æµé‡è¶…é™å®¢æˆ·ç«¯ â†’ åœç”¨å®¹å™¨
    â†“
æ£€æŸ¥éœ€è¦é‡ç½®çš„å®¢æˆ·ç«¯ â†’ é‡ç½®æµé‡ â†’ é‡æ–°å¯ç”¨
```

## ğŸ”§ æŠ€æœ¯æ ˆ

- **åç«¯**: Node.js + Express
- **æ•°æ®åº“**: SQLite (better-sqlite3)
- **è®¤è¯**: JWT + bcryptjs
- **å®¹å™¨ç®¡ç†**: Dockerode
- **å®šæ—¶ä»»åŠ¡**: node-cron
- **åè®®æ”¯æŒ**: Reality + Hysteria2

## ğŸ“ API ç«¯ç‚¹æ€»è§ˆ

### è®¤è¯
- POST `/api/auth/login` - ç®¡ç†å‘˜ç™»å½•
- GET `/api/auth/verify` - éªŒè¯ Token

### å®¢æˆ·ç«¯ç®¡ç†ï¼ˆéœ€è¦è®¤è¯ï¼‰
- GET `/api/clients` - åˆ—è¡¨
- POST `/api/clients` - åˆ›å»º
- GET `/api/clients/:id` - è¯¦æƒ…
- PUT `/api/clients/:id` - æ›´æ–°
- DELETE `/api/clients/:id` - åˆ é™¤
- GET `/api/clients/:id/traffic` - æµé‡å†å²
- POST `/api/clients/:id/reset-traffic` - é‡ç½®æµé‡
- GET `/api/clients/:id/urls` - è¿æ¥ URL
- GET `/api/clients/:id/docker-compose` - Docker é…ç½®

### åˆ†äº«é¡µé¢ï¼ˆå…¬å¼€ï¼‰
- GET `/api/share/:token` - åˆ†äº«é¡µé¢æ•°æ®

## ğŸ¯ å¾…å®ŒæˆåŠŸèƒ½ï¼ˆPhase 3 & 4ï¼‰

### Phase 3: å‰ç«¯æ”¹é€ 
- [ ] å°†å‰ç«¯å‚è€ƒä»£ç è½¬ä¸ºçº¯ JS
- [ ] æ¥å…¥åç«¯ API
- [ ] å®ç°ç™»å½•é¡µé¢
- [ ] å®ç°å®¢æˆ·ç«¯ç®¡ç†é¡µé¢
- [ ] å®ç°å®¢æˆ·ç«¯è¯¦æƒ…é¡µé¢
- [ ] å®ç°åˆ†äº«é¡µé¢ UI
- [ ] å›¾è¡¨é›†æˆï¼ˆæµé‡è¶‹åŠ¿ï¼‰

### Phase 4: åŠŸèƒ½å¢å¼º
- [ ] æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡åˆ›å»º/åˆ é™¤ï¼‰
- [ ] æ•°æ®å¯¼å‡ºï¼ˆExcel/CSVï¼‰
- [ ] å¤šç®¡ç†å‘˜æ”¯æŒ
- [ ] API è®¿é—®é¢‘ç‡é™åˆ¶
- [ ] WebSocket å®æ—¶æµé‡æ¨é€
- [ ] é€šçŸ¥ç³»ç»Ÿï¼ˆé‚®ä»¶/Webhookï¼‰
- [ ] å›½é™…åŒ–æ”¯æŒï¼ˆi18nï¼‰
- [ ] æš—è‰²æ¨¡å¼
- [ ] ç§»åŠ¨ç«¯é€‚é…

## âš ï¸ é‡è¦æç¤º

1. **å®‰å…¨æ€§**
   - âœ… åŠ¡å¿…ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
   - âœ… ä½¿ç”¨å¼ºéšæœº JWT_SECRET
   - âœ… ç”Ÿäº§ç¯å¢ƒé…ç½® HTTPS
   - âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“

2. **Docker Socket æƒé™**
   - éœ€è¦è®¿é—® `/var/run/docker.sock`
   - ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„æƒé™

3. **ç«¯å£è§„åˆ’**
   - ç®¡ç†åå°: 3000
   - å®¢æˆ·ç«¯å®¹å™¨: Reality (TCP) + Hysteria2 (UDP)
   - é¿å…ç«¯å£å†²çª

4. **æµé‡ç›‘æ§é—´éš”**
   - é»˜è®¤ 60 ç§’
   - å®¢æˆ·ç«¯æ•°é‡å¤šæ—¶å¯é€‚å½“å¢åŠ 

## ğŸ“š æ–‡æ¡£

- [README.md](README.md) - é¡¹ç›®æ¦‚è§ˆå’Œå¿«é€Ÿå¼€å§‹
- [DEVELOPMENT.md](DEVELOPMENT.md) - å¼€å‘æŒ‡å—å’Œæ¶æ„è¯´æ˜
- [DEPLOYMENT.md](DEPLOYMENT.md) - Docker éƒ¨ç½²è¯¦ç»†æ­¥éª¤

## ğŸ§ª æµ‹è¯•

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```bash
# å¯åŠ¨æœåŠ¡åè¿è¡Œ
./test-api.sh
```

æµ‹è¯•è¦†ç›–ï¼š
- å¥åº·æ£€æŸ¥
- ç®¡ç†å‘˜ç™»å½•
- åˆ›å»ºå®¢æˆ·ç«¯
- è·å–è¯¦æƒ…
- æ›´æ–°é…ç½®
- è·å–è¿æ¥ URL
- åˆ†äº«é¡µé¢
- åˆ é™¤å®¢æˆ·ç«¯

### æ‰‹åŠ¨æµ‹è¯•

ä½¿ç”¨ Postman æˆ– curl æµ‹è¯•å„ä¸ª API ç«¯ç‚¹ã€‚

## ğŸ“ˆ åç»­ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
   - æµé‡ç›‘æ§æ‰¹å¤„ç†
   - ç¼“å­˜æœºåˆ¶

2. **ç›‘æ§å‘Šè­¦**
   - Prometheus é›†æˆ
   - Grafana ä»ªè¡¨ç›˜
   - å‘Šè­¦è§„åˆ™é…ç½®

3. **é«˜å¯ç”¨**
   - æ•°æ®åº“ä¸»ä»å¤åˆ¶
   - è´Ÿè½½å‡è¡¡
   - æ•…éšœè½¬ç§»

## ğŸ‰ æ€»ç»“

**Phase 1 + Phase 2 å·²å…¨éƒ¨å®Œæˆï¼**

æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼š
- âœ… å®Œæ•´çš„åç«¯ API ç³»ç»Ÿ
- âœ… çœŸå®çš„ Docker æµé‡ç›‘æ§
- âœ… è‡ªåŠ¨åŒ–æµé‡é™åˆ¶å’Œåˆ°æœŸç®¡ç†
- âœ… å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… åˆ†äº«é¡µé¢æ”¯æŒ
- âœ… Docker éƒ¨ç½²é…ç½®

ä½ ç°åœ¨å¯ä»¥ï¼š
1. ç›´æ¥éƒ¨ç½²å¹¶ä½¿ç”¨åç«¯ API
2. é€šè¿‡ API ç®¡ç† sing-box å®¢æˆ·ç«¯
3. å®æ—¶ç›‘æ§æµé‡ä½¿ç”¨æƒ…å†µ
4. è‡ªåŠ¨æ‰§è¡Œæµé‡é™åˆ¶

ä¸‹ä¸€æ­¥å»ºè®®ï¼š
1. å…ˆæµ‹è¯•åç«¯ API ç¡®ä¿åŠŸèƒ½æ­£å¸¸
2. å†å¼€å§‹å‰ç«¯å¼€å‘ï¼ˆPhase 3ï¼‰
3. æˆ–è€…ç›´æ¥ç”¨ç°æœ‰å‰ç«¯å‚è€ƒä»£ç å¯¹æ¥ API

---

**é¡¹ç›®çŠ¶æ€**: âœ… åç«¯å®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”¨
**å¼€å‘æ—¶é—´**: Phase 1 + Phase 2
**ä»£ç è´¨é‡**: ç”Ÿäº§å°±ç»ª

éœ€è¦ç»§ç»­å¼€å‘å‰ç«¯æˆ–æœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼
