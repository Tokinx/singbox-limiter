<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客户端详情 - SingBox Limiter</title>
  <link rel="stylesheet" href="/src/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo" style="cursor: pointer;" onclick="window.location.href='/dashboard.html'">← SingBox Limiter</div>
      <button class="btn btn-secondary" onclick="logout()">退出登录</button>
    </div>
  </div>

  <div class="container">
    <div id="clientDetail"></div>
  </div>

  <script type="module">
    import { api, getToken, clearToken, formatBytes, formatDate, showToast, copyToClipboard, confirm } from './src/utils/api.js';

    if (!getToken()) {
      window.location.href = '/';
    }

    window.logout = function() {
      if (window.confirm('确定要退出登录吗？')) {
        clearToken();
        window.location.href = '/';
      }
    };

    const params = new URLSearchParams(window.location.search);
    const clientId = params.get('id');

    if (!clientId) {
      window.location.href = '/dashboard.html';
    }

    let client = null;
    let trafficChart = null;
    let currentTimeRange = 24; // 默认 24 小时

    const timeRanges = [
      { label: '最近1小时', hours: 1 },
      { label: '最近24小时', hours: 24 },
      { label: '最近7天', hours: 168 },
      { label: '最近31天', hours: 744 }
    ];

    async function loadClient() {
      try {
        client = await api.getClient(clientId);
        const traffic = await api.getTraffic(clientId, currentTimeRange);
        renderClient(client, traffic);
      } catch (error) {
        showToast('加载失败: ' + error.message);
      }
    }

    async function loadTraffic(hours) {
      currentTimeRange = hours;
      try {
        const traffic = await api.getTraffic(clientId, hours);
        renderChart(traffic, hours);
        updateTimeRangeButtons();
      } catch (error) {
        showToast('加载流量数据失败: ' + error.message);
      }
    }

    function updateTimeRangeButtons() {
      timeRanges.forEach(range => {
        const btn = document.getElementById(`range-${range.hours}`);
        if (btn) {
          btn.className = range.hours === currentTimeRange ? 'btn btn-primary' : 'btn btn-secondary';
        }
      });
    }

    function renderClient(client, traffic) {
      const container = document.getElementById('clientDetail');
      const usagePercent = client.limit_bytes > 0 ? (client.used_bytes / client.limit_bytes) * 100 : 0;
      const shareUrl = `${window.location.origin}/share.html#${client.share_token}`;

      const timeRangeButtons = timeRanges.map(range => `
        <button id="range-${range.hours}" class="btn ${range.hours === currentTimeRange ? 'btn-primary' : 'btn-secondary'}"
                style="padding: 6px 12px; font-size: 13px;"
                onclick="window.loadTraffic(${range.hours})">${range.label}</button>
      `).join('');

      container.innerHTML = `
        <div class="card">
          <h2 style="font-size: 24px; margin-bottom: 20px;">${client.name}</h2>

          <div class="grid grid-2" style="margin-bottom: 30px;">
            <div>
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">流量使用</div>
              <div style="font-size: 28px; font-weight: 700;">${formatBytes(client.used_bytes)}</div>
              <div style="font-size: 14px; color: var(--gray-600); margin-top: 4px;">
                / ${client.limit_bytes > 0 ? formatBytes(client.limit_bytes) : '无限制'}
              </div>
              ${client.limit_bytes > 0 ? `
                <div class="progress-bar" style="margin-top: 12px; height: 10px;">
                  <div class="progress-fill" style="width: ${Math.min(100, usagePercent)}%; background: ${usagePercent > 90 ? 'var(--danger)' : 'var(--primary)'}"></div>
                </div>
              ` : ''}
            </div>

            <div>
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">状态信息</div>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div>
                  状态: ${client.active ? '<span class="badge badge-success">启用</span>' : '<span class="badge badge-danger">停用</span>'}
                </div>
                <div>
                  容器: ${client.containerRunning ? '<span class="badge badge-success">运行中</span>' : '<span class="badge badge-danger">已停止</span>'}
                </div>
                <div>到期: ${formatDate(client.expiry_date)}</div>
                <div>重置日: 每月 ${client.reset_day} 号</div>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="getUrls()">获取连接</button>
            <button class="btn btn-success" onclick="shareClient()">分享页面</button>
            <button class="btn btn-secondary" onclick="resetTraffic()">重置流量</button>
            <button class="btn btn-secondary" onclick="toggleActive()">${client.active ? '停用' : '启用'}</button>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
            <h3 style="margin: 0;">流量趋势</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${timeRangeButtons}
            </div>
          </div>
          <canvas id="trafficChart" style="max-height: 300px;"></canvas>
        </div>
      `;

      renderChart(traffic, currentTimeRange);
    }

    function renderChart(traffic, hours) {
      const ctx = document.getElementById('trafficChart');

      if (trafficChart) {
        trafficChart.destroy();
      }

      // 根据时间范围格式化标签
      const formatLabel = (timestamp) => {
        const date = new Date(timestamp);
        if (hours <= 1) {
          return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        } else if (hours <= 24) {
          return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        } else if (hours <= 168) {
          return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit' });
        } else {
          return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
        }
      };

      const labels = traffic.map(t => formatLabel(t.timestamp));
      // 合并上行下行流量
      const totalTraffic = traffic.map(t => (t.upload_bytes + t.download_bytes) / 1024 / 1024);

      trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: '流量 (MB)',
              data: totalTraffic,
              borderColor: 'rgb(99, 102, 241)',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'MB'
              }
            }
          }
        }
      });
    }

    window.loadTraffic = loadTraffic;

    window.getUrls = async function() {
      try {
        const urls = await api.getUrls(clientId);
        const modal = document.createElement('div');
        modal.innerHTML = `
          <div class="modal-overlay" onclick="this.parentElement.remove()">
            <div class="modal" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h2>连接 URL</h2>
                <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label class="label">Reality</label>
                  <div style="display: flex; gap: 8px;">
                    <input type="text" class="input" value="${urls.reality}" readonly id="realityUrl" />
                    <button class="btn btn-secondary" onclick="copyUrl('realityUrl')">复制</button>
                  </div>
                </div>
                <div class="form-group">
                  <label class="label">Hysteria2</label>
                  <div style="display: flex; gap: 8px;">
                    <input type="text" class="input" value="${urls.hysteria2}" readonly id="hy2Url" />
                    <button class="btn btn-secondary" onclick="copyUrl('hy2Url')">复制</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        showToast('获取失败: ' + error.message);
      }
    };

    window.copyUrl = async function(id) {
      const input = document.getElementById(id);
      await copyToClipboard(input.value);
      showToast('已复制到剪贴板');
    };

    window.shareClient = async function() {
      const shareUrl = `${window.location.origin}/share.html#${client.share_token}`;
      await copyToClipboard(shareUrl);
      showToast('分享链接已复制: ' + shareUrl);
    };

    window.resetTraffic = async function() {
      if (!window.confirm('确定要重置流量吗？')) return;

      try {
        await api.resetTraffic(clientId);
        showToast('重置成功');
        loadClient();
      } catch (error) {
        showToast('重置失败: ' + error.message);
      }
    };

    window.toggleActive = async function() {
      const newState = !client.active;

      try {
        await api.updateClient(clientId, { active: newState });
        showToast(newState ? '已启用' : '已停用');
        loadClient();
      } catch (error) {
        showToast('操作失败: ' + error.message);
      }
    };

    loadClient();
    setInterval(loadClient, 30000);
  </script>
</body>
</html>
